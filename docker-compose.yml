# docker-compose.yml
version: '3.9'

services:
  astro:
    image: node:20-alpine 
    platform: linux/arm64 
    working_dir: /app
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - pnpm_store:/root/.local/share/pnpm/store  
    ports:
      - "4321:4321"
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true 
    command: >
      sh -c "
        apk add --no-cache python3 make g++ &&  # sharp 等 native 模块可能需要编译工具（仅首次）
        corepack enable &&
        corepack prepare pnpm@latest --activate &&
        pnpm install --frozen-lockfile &&
        pnpm run dev --host --allowed-hosts=all
      "
    tty: true
    stdin_open: true
    init: true  

volumes:
  node_modules:
  pnpm_store:
